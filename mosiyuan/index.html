<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="shortcut icon" type="image/ico" href="./favicon.ico"/>
		<title>膜拜Siyuan</title>
	</head>
	<body>
		<style>
			#global{
				position: fixed;
				left:0;
				top:0;
				width: 100%;
				height: 100%;
				pointer-events:none;
				z-index: 1;
			}
		</style>
		<div id="global" class="global"></div>
		<div id="app"></div>
		<script>
			{
				Object.defineProperty(window,'LOCAL',{get:()=>true});
				'use strict';
				function toAbsLoc(loc){
					let a=document.createElement('a');
					a.href=loc;
					return a.href;
				}
				function loadTag(text){
					let qaq=document.createElement('div');
					qaq.innerHTML=text;
					let element=document.getElementById('global');
					element.appendChild(qaq);
					return {
						get text(){
							return qaq.innerHTML;
						},
						set text(newText){
							qaq.innerHTML=newText;
						},
						remove(){
							element.removeChild(qaq);
						},
					};
				}
				async function loadByElement(tagName,defaultAttr,attrName,urls){
					urls=urls.map(toAbsLoc);
					let score=
						window.location.hostname.includes('.github.io')?
						(url)=>(url.includes('cdn')?1:0)
						:(url)=>(url.includes('cdn')?0:1);
					urls.sort((x,y)=>score(y)-score(x));
					let handler=loadTag('');
					for(let url of urls){
						let element=document.createElement(tagName);
						for(let name in defaultAttr){
							element.setAttribute(name,defaultAttr[name]);
						}
						element.setAttribute(attrName,url);
						handler.text+=`Loading <span style="font-family:monospace;">${url}</span> ...`;
						try{
							await new Promise((resolve,reject)=>{
								element.addEventListener('load',resolve);
								element.addEventListener('error',reject);
								document.body.appendChild(element);
							});
							handler.text+=` <span style="color:green;">Done.</span><br>`;
							// handler.remove();
							return url;
						}
						catch(_){
							handler.text+=` <span style="color:red;">Failed.</span><br>`;
							document.body.removeChild(element);
						}
						first=false;
					}
					throw `load failed:\n${urls.join('\n')}`;
				}
				function loadScript(urls){
					return loadByElement('script',{},'src',urls);
				}
				function loadCSS(urls){
					return loadByElement('link',{rel:'stylesheet'},'href',urls);
				}
				async function loadText(urls){
					urls=urls.map(toAbsLoc);
					let score=
						window.location.hostname==='lmoliver.github.io'?
						(url)=>(url.includes('cdn')?1:0)
						:(url)=>(url.includes('cdn')?0:1);
					urls.sort((x,y)=>score(y)-score(x));
					let handler=loadTag('');
					for(let url of urls){
						handler.text+=`Loading <span style="font-family:monospace;">${url}</span> ...`;
						try{
							let result=(await axios.get(url)).data;
							handler.text+=` <span style="color:green;">Done.</span><br>`;
							return result;
						}
						catch(e){
							handler.text+=` <span style="color:red;">Failed.</span><br>`;
							continue;
						}
					}
					throw `load failed:\n${urls.join('\n')}`;
				}
				Promise.all([
					Promise.all([
						LOCAL
							?loadScript(['https://cdn.jsdelivr.net/npm/vue/dist/vue.js','../vue.dev.js'])
							:loadScript(['https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js','../vue.js']),
						loadScript(['https://cdn.jsdelivr.net/npm/axios@0.19.0/dist/axios.min.js','../axios.js'])
						.then(
							()=>Promise.all([
								loadScript(['https://cdn.jsdelivr.net/gh/lmoliver/lmoliver.github.io@master/mosiyuan/lang.min.js','./lang.js']),
								loadText(['./ui.html']).then((result)=>{window.GAME_UI=result;}),
							])
						),
					])
					.then(()=>loadScript(['https://cdn.jsdelivr.net/gh/lmoliver/lmoliver.github.io@master/mosiyuan/mosiyuan.min.js','./mosiyuan.js'])),
					loadCSS(['https://cdn.jsdelivr.net/gh/lmoliver/lmoliver.github.io@master/normalize.min.css','../normalize.css']),
					loadCSS(['https://cdn.jsdelivr.net/gh/lmoliver/lmoliver.github.io@master/default.min.css','../default.css']),
					loadCSS(['https://cdn.jsdelivr.net/gh/lmoliver/lmoliver.github.io@master/mosiyuan/mosiyuan.min.css','./mosiyuan.css']),
				])
				.then(()=>{
					document.getElementById('global').innerHTML='';
				});
			}
		</script>
	</body>
</html>